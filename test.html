<!DOCTYPE html>
<html>
<head>
<style>

    #viewport {
        //float: left;
        position: relative;
        //width:100%;
        //height:500px;
        margin:0 auto;
        overflow: hidden;
        //border: solid;
    }
    .info {
        font-family: "Open Sans", sans-serif;
        font-size: 110%;
        line-height: 1.35em;
        color: #3a3a3a;
        background-color: #eeeeee;
        border-color: #888888;
        padding: 15px;
        margin-bottom: 20px;
        border: 1px solid;
        border-radius: 4px;
    }
    .zone {
        left:40px;
        top:40px;
        width:400px;
        height:300px;
        border-color: black;
        border-style: solid;
        border-width: 2px;
        position: absolute;
        
        -webkit-animation: blink 1s infinite;
        -moz-animation:    blink 1s infinite;
        -ms-animation:     blink 1s infinite;

    }
    .image {
        margin:0px;
        //position:absolute;
        display: block;
        width:100%;
        //max-height:100%;
    }
    .cursor {
        position:relative;
        left:100px;
        top: 100px;
        width:20px;
    }
    @-webkit-keyframes blink {
        0%   { border-color:#777; }
        50%  { border-color:#000;}
        100% { border-color:#777; }
    }
    @-moz-keyframes blink {
        0%   { border-color:#777; }
        50%  { border-color:#000;}
        100% { border-color:#777; }
    }
    @-ms-keyframes blink {
        0%   { border-color:#777; }
        50%  { border-color:#000;}
        100% { border-color:#777; }
    }
    .click {
        visibility: hidden;
        border-radius: 50%;
        border-color: red;
        border-style: solid;
        border-width: 4px;
        opacity: 0.5;
        width:0px;
        height:0px;
        //background: beige;
        position: absolute;
        top:50px;
        left:50px;
    }
</style>
<link href="css/bootstrap.min.css" rel="stylesheet">
<script src="js/jquery-1.11.3.min.js"></script>
<script src="js/velocity.min.js"></script>
<script src="js/velocity.ui.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/showdown.min.js"></script>
<script src="data.js"></script>
<script> 
var converter = new showdown.Converter();
var clickcircle = 50;
var step = 0;
var substep = 0;
var zoom;
var cursor_x = 450;
var cursor_y = 350;
var current;
var mySequence;
var zoomActive=false;
var play=false;
var delay = 0;
var viewport;
var viewport_w;
var viewport_h;
var im_w;
var im_h;
var tx;
var ty;
var viewport_x = cursor_x;
var viewport_x0;
var viewport_y = cursor_y;
var viewport_y0;

function initViewport() {
        im_w = document.getElementById('im1').naturalWidth;
        im_h = document.getElementById('im1').naturalHeight;
        viewport = document.getElementById('viewport');
        if (viewport.clientWidth != viewport_w) {
            viewport_w = viewport.clientWidth;
            viewport_h = viewport.clientHeight;
        }
        $('#viewport').css('height',viewport_h);
        console.log('viewport_w='+viewport_w+', viewport_h='+viewport_h);

    }
   function loadSequence() {
       mySequence = [];
       for (j=0;j<sce.steps.length;j++) {
           var seq = sce.steps[j];
           for (i=0;i<seq.length;i++) {
               s = seq[i];
               if ((s.action === 'stepStart') || (s.action === 'showImage') || (s.action === 'stepEnd')) {
                   changeImage(s.image,300);
               }
               if (s.action === 'click') {
                   zoomWindow(s.active.x,s.active.y,s.active.w,s.active.h,1000);
                   moveCursor(s.x,s.y,1500);
                   startClick(s.button,s.count,true,150);
               }
               if (s.action === 'zoomTo') {
                   console.log('zoom');
                   zoomWindow(s.zone.x,s.zone.y,s.zone.w,s.zone.h,1000);
               }
               if (s.action === 'text') {
                  changeText(s.content,s.type,300);
               }
               if (s.action === 'wait') {
                  delay = s.time;
               }
               if (s.wait) delay = s.wait;

           }
       }
       zoomWindow(0,0,im_w,im_h,1000);

   }
       function showImage(image) {
           console.log('showImage '+image);
           $("#im1").attr('src',image);
       }
       function showImageCallback(image) {
            console.log('showImageCallback '+image);
            return function() { showImage(image);};
       }
       function updateVars() {
           current = sce[step];
           im_x = current['mousex'];
           im_y = current['mousey'];
           if (im_x != 0 || im.y != 0)  {
               updateCursor(im_x,im_y);            
           }
           updateZoom();
       }
       function updateCursor(x,y) {
           im_x = x;
           im_y = y;
           viewport_x = (x /im_w) * viewport_w*zoom - viewport_x0;
           viewport_y = (y /im_h) * viewport_h*zoom - viewport_y0;
       }
       
       function updateZoom(z) {
           if (z == undefined) {
               zoom = 1.5;
           } else {
               zoom = z;
           }
            
           tx = viewport_w*(zoom-1)/2-viewport_x*(zoom-1); 
           ty = viewport_h*(zoom-1)/2-viewport_y*(zoom-1);
       }
       function zoomImage(z,speed,queue) {
           if (speed == undefined) {
            speed=1500;
           }
           if (queue == undefined) {
            queue = false;
           }
           updateZoom(z);
           mySequence.push({ e: $('#im1'), p: {scale:zoom, left: tx+"px",top:ty+"px"}, options: { delay:delay, duration: speed,  sequenceQueue: queue, easing:'easeInSine' } });
        }
       function zoomWindow(x,y,w,h,speed,queue) {
         console.log('viewport_w='+viewport_w+', viewport_h='+viewport_h);

         if (speed == undefined) {
            speed=1500;
           }
           if (queue == undefined) {
            queue = true;
           }
         x = x - w * 0.01;
         y = y - h * 0.01;
         w = w * 1.02;
         h = h * 1.02;
         
         console.log('x='+x+', y='+y+', w='+w+', h='+h);
         var vx = x / im_w * viewport_w;
         var vy = y / im_h * viewport_h;
         var vw = w / im_w * viewport_w;
         var vh = h / im_h * viewport_h;
         console.log('vx='+vx+', vy='+vy+', vw='+vw+', vh='+vh);

         var zw = viewport_w/vw;
         var zh = viewport_h/vh;
         console.log('zw='+zw,' zh='+zh);
         if (zw>zh) {
            var z = zh;
         } else {
            var z = zw;
         }
         if (z>2) {
            z = 2;
         }
         if (z<1) {
            z = 1;
         }
         
         // Pour centrer la fenetre
         tx0 = viewport_w * (z-1) / 2;
         ty0 = viewport_h * (z-1) / 2;
         cw = (viewport_w - vw * z) /2 - vx*z;
         if (cw>0) cw=0;
         if (cw<-2*tx0) cw = -2*tx0;
         ch = (viewport_h - vh * z) /2 - vy*z;
         if (ch>0) ch=0;
         console.log('cw='+cw+', ch='+ch);
       
         var _tx = tx0 + cw; 

         var _ty = ty0 + ch;

         if ((_tx != tx) && (_ty != ty) && ( z != zoom)) {
             tx = _tx;
             ty = _ty;
             zoom = z;
         
             viewport_x0 = -cw;
             viewport_y0 = -ch;
             console.log("viewport_x0="+viewport_x0+", viewport_y0="+viewport_y0);
             console.log("z="+z);
             console.log("tx="+tx+", ty="+ty);
             
             mySequence.push({ e: $('#im1'), p: {scale:zoom, marginLeft: tx+"px",marginTop:ty+"px"}, options: { delay:delay, duration: speed,  easing:'easeInSine' } });
             delay = 0;
         }

       }
       function changeImage(image,speed) {
           if (speed == undefined) {
            speed=50;
           }
           console.log('viewport_x='+viewport_x+', viewport_y='+viewport_y);
           mySequence.push({ e: $('.cursor'), p: {left:(viewport_x)+'px',top:(viewport_y)+'px'}, options: { delay:delay, duration: speed, easing:'easeOutQuart', complete: showImageCallback(image) } });
           delay = 0;
       }
       function showText(text) {
            $('#info').velocity({ opacity: 0 }, { duration:750, complete: function () {
            $('#info').html(text); }})
            .velocity("transition.slideUpIn", { 
                display: null,
                duration: 1250,
                stagger: 40
               
            });
       }
       function showTextCallback(text) {
           return function() { showText(text);};
       }
       function changeText(content,type,speed) {
           if (speed == undefined) {
            speed=50;
           }
           if (type === 'markdown') content = converter.makeHtml(content);
           
           mySequence.push({ e: $('.cursor'), p: {left:(viewport_x)+'px',top:(viewport_y)+'px'}, options: { duration: speed, easing:'easeOutQuart', complete: showTextCallback(content) } });
       }
       
       
       function moveCursor(nx,ny,speed,complete) {
           if (speed == undefined) {
            speed=1500;
           }
           
           if (nx != 0 || ny != 0) {
               console.log('udateCursor '+nx+','+ny);
               updateCursor(nx,ny);
               mySequence.push({ e: $('.cursor'), p: {left:(viewport_x)+'px',top:(viewport_y)+'px'}, options: { delay:delay, duration: speed, easing:'easeOutQuart', complete: complete } });
               mySequence.push({e: $('.click'), p:{left:(viewport_x-clickcircle/4)+'px',top:(viewport_y-clickcircle/4)+'px',width:(clickcircle/2)+'px',height:(clickcircle/2)+'px'}, options: { delay:delay, duration:0, sequenceQueue: true }});

           }
           delay = 0;
       }
       function startClick(btn,repeat,full,speed) {
           if (speed == undefined) {
            speed=400;
           }
           console.log(repeat);
           if (full == undefined) {
            full=true;
           }
           if (btn == 'Left') {
            var color = 'green';
           } else if (btn == 'Right') {
            var color = 'yellow';
           } else if (btn == 'Middle') {
            var color = 'red';
           }
           console.log(color);
           for (r=0;r<repeat;r++) {
               mySequence.push({e: $('.click'), p:{ left:(viewport_x-clickcircle/2)+'px',top:(viewport_y-clickcircle/2)+'px',width:(clickcircle)+'px',height:(clickcircle)+'px'}, options: { delay:delay, duration:0, complete: function () { $('.click').css('border-color',color).css('visibility','visible');} }});
               mySequence.push({ e: $('.click'), p: {left:(viewport_x-clickcircle/4)+'px',top:(viewport_y-clickcircle/4)+'px',width:(clickcircle/2)+'px',height:(clickcircle/2)+'px'}, options: { duration: speed/repeat}});
           }
           if (full) {
               mySequence.push({ e: $('.click'), p: {left:(viewport_x-2)+'px',top:(viewport_y-2)+'px',width:'4px',height:'4px'}, options: { duration: speed/repeat, complete: function () { $('.click').css('visibility','hidden');}}});
           }
           delay = 0;

       }
       
       function endClick(speed) {
           if (speed == undefined) {
              speed=400;
           }
           mySequence.push({ e: $('.click'), p: {left:(viewport_x-2)+'px',top:(viewport_y-2)+'px',width:'4px',height:'4px'}, options: { duration: speed, complete: function () { $('.click').css('visibility','hidden');}}});
       }
       
$(document).ready(function(){
    
    //$.getJSON( "test.json", function( data ) {
    //    sce = data;
    //});
    $("#im1").attr('src',sce['image']);
    $("#start").click(function(){
        play=true;
        go();
    });    
    $('next').click(function() {
    });
   
   
   $( window ).resize(function() {
       
        location.reload();
    }); 
   function go() {
          loadSequence();     
          $.Velocity.RunSequence(mySequence);
   }

       
       
   $(function () {
  $('[data-toggle="popover"]').popover()
  })
});
</script> 
</head>
<body>
<div class="container">
<button id="start" type="button" class="btn btn-primary">Start Animation</button>
<div class="row">
    <div class="col-md-12">
    <div class="panel panel-default">
        <div class="panel-body">
            <div id="viewport">
                <img id="im1" class="image" onload="initViewport();"/>
                <div style="left:0; top:0; position: absolute;">
            		<div class="click"></div>
            		<img class="cursor" src="cursor.png"/>
                </div>
            </div>
        </div>
    </div>
    </div>
<div class="col-md-12">
<div class="info" id="info" style="opacity:0;"></div>
 
</div>

</div>
</div>
</body>
</html>

