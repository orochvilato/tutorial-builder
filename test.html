<!DOCTYPE html>
<html>
<head>
<style>

    #viewport {
        //float: left;
        position: relative;
        //width:100%;
        //height:500px;
        margin:0 auto;
        overflow: hidden;
        //border: solid;
    }
    .info {
        font-family: "Open Sans", sans-serif;
        font-size: 110%;
        line-height: 1.35em;
        color: #3a3a3a;
        background-color: #eeeeee;
        border-color: #888888;
        padding: 15px;
        margin-bottom: 20px;
        border: 2px solid;
        border-radius: 6px;
    }
    .msgbox {
        position: absolute;
        top:30%;
        left:30%;
        width:40%;
        height:40%;
        display: flex;
        align-items: center; 
        text-align: center;
    }
    .zone {
        left:40px;
        top:40px;
        width:400px;
        height:300px;
        border-color: black;
        border-style: solid;
        border-width: 2px;
        position: absolute;
        
        -webkit-animation: blink 1s infinite;
        -moz-animation:    blink 1s infinite;
        -ms-animation:     blink 1s infinite;

    }
    .image {
        margin:0px;
        //position:absolute;
        display: block;
        width:100%;
        //max-height:100%;
    }
    .cursor {
        position:relative;
        left:100px;
        top: 100px;
        width:20px;
    }
    @-webkit-keyframes blink {
        0%   { border-color:#777; }
        50%  { border-color:#000;}
        100% { border-color:#777; }
    }
    @-moz-keyframes blink {
        0%   { border-color:#777; }
        50%  { border-color:#000;}
        100% { border-color:#777; }
    }
    @-ms-keyframes blink {
        0%   { border-color:#777; }
        50%  { border-color:#000;}
        100% { border-color:#777; }
    }
    .click {
        visibility: hidden;
        border-radius: 50%;
        border-color: red;
        border-style: solid;
        border-width: 4px;
        opacity: 0.5;
        width:0px;
        height:0px;
        //background: beige;
        position: absolute;
        top:50px;
        left:50px;
    }
</style>
<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="css/font-awesome.min.css" rel="stylesheet">
<script src="js/jquery-1.11.3.min.js"></script>
<script src="js/velocity.min.js"></script>
<script src="js/velocity.ui.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/showdown.min.js"></script>
<script src="data.js"></script>
<script> 
var converter = new showdown.Converter();
var clickcircle = 50;
var step = 0;
var substep = 0;
var zoom = 1;
var cursor_x = 450;
var cursor_y = 350;
var current;
var currentStep;
var mySequence;
var newSequence = [];
var fullSequence;
var Seq;
var mySteps;
var zoomActive=false;
var playon=false;
var delay = 0;
var viewport;
var viewport_w;
var viewport_h;
var im_w;
var im_h;
var tx;
var ty;
var viewport_x = cursor_x;
var viewport_x0=0;
var viewport_y = cursor_y;
var viewport_y0=0;
var lm_w;
var rm_w;
var rm_x;
var tm_h;
var bm_h;
var bm_y;     
var zoom_x;
var zoom_y;
var zoom_h;
var zoom_w;
var mask_x;
var mask_y;
var mask_h;
var mask_w;
var mouse_x;
var mouse_y;

function initViewport() {
        
        im_w = document.getElementById('im1').naturalWidth;
        im_h = document.getElementById('im1').naturalHeight;
        viewport = document.getElementById('viewport');
        if (viewport.clientWidth != viewport_w) {
            viewport_w = viewport.clientWidth;
            viewport_h = viewport.clientHeight;
            $('#mask').attr('width',viewport_w).attr('height',viewport_h);
            $('#leftmask').attr('x',0).attr('y',0).attr('width',0).attr('height',viewport_h);
            $('#rightmask').attr('x',viewport_w).attr('y',0).attr('width',0).attr('height',viewport_h);
            $('#topmask').attr('x',0).attr('y',0).attr('width',viewport_w).attr('height',0);
            $('#bottommask').attr('x',0).attr('y',viewport_h).attr('width',viewport_w).attr('height',0);
            zoom = 1;
            zoom_x = 0;
            zoom_y = 0;
            zoom_w = im_w;
            zoom_h = im_h;
            mask_x = 0;
            mask_y = 0;
            mask_w = im_w;
            mask_h = im_h;
            mouse_x = cursor_x;
            mouse_y = cursor_y;
            zoom = 1;
        }
        $('#viewport').css('height',viewport_h);
        if (fullSequence == undefined) {
            loadSequence();
            currentStep = 0;
        }
        
        console.log('viewport_w='+viewport_w+', viewport_h='+viewport_h);

    }
function initStep(step) {
    s = mySteps[step];
    if (s.image != $('#im1').attr('src')) changeImage(newSequence,s.image,0);
    if (s.zoom && (s.zoom.x != zoom_x || s.zoom.x != zoom_y || s.zoom.w != zoom_w || s.zoom.h != zoom_h))
        zoomWindow(newSequence,s.zoom.x,s.zoom.y,s.zoom.w,s.zoom.h,0);
    if (s.mask && (s.mask.x != mask_x || s.mask.y != mask_y || s.mask.w != mask_w || s.mask.h != mask_h))
        maskWindow(newSequence,s.mask.x,s.mask.y,s.mask.w,s.mask.h,0);
    if (s.mouse && (s.mouse.x != mouse_x || s.mouse.y != mouse_y))
        console.log('mouse : '+s.mouse.x+", "+s.mouse.y);
        moveCursor(newSequence,s.mouse.x,s.mouse.y,0);
    if (s.title)
        addStepTitle(newSequence,s.title);

}
function setStep(seq,value) {
    console.log('value='+value);
    seq.push({ e: $('#step'), p:{opacity:1}, options:{ duration:0, complete: function () {
           currentStep = value;
           console.log("currentStep :"+currentStep);
    }}});

}
function loadSequence() {
       fullSequence = [];
       mySteps = [];
       currentStep = 0;
       for (i=0;i<sce.steps.length;i++) {
           s = sce.steps[i];
           if (s.action === 'step') {
               if (s.title) {
                   var title = s.title;
               } else {
                   var title = "Step "+(mySteps.length+1);
               }

               setStep(fullSequence, currentStep + 1);
               currentStep++;
               
               myStep = {'i':fullSequence.length, 'image':s.image,'title':title};
               addStepTitle(fullSequence,title);
           }

           if (s.action === 'loadImage' || s.action === 'step') {
               changeImage(fullSequence,s.image,300);
           }
           if (s.action === 'click') {
               maskWindow(fullSequence,s.active.x,s.active.y,s.active.w,s.active.h,1000);
               zoomWindow(fullSequence,s.active.x,s.active.y,s.active.w,s.active.h,1000);
               moveCursor(fullSequence,s.x,s.y,1500);
               startClick(fullSequence,s.button,s.count,true,150);
           }
           if (s.action === 'zoomTo') {
               console.log('zoom');
               zoomWindow(fullSequence,s.zone.x,s.zone.y,s.zone.w,s.zone.h,1000);
           }
           if (s.action === 'text') {
               changeText(fullSequence,s,300);
           }
           if (s.action === 'wait') {
               delay = s.time;
           }
           if (s.action === 'step') {
               myStep['zoom']={'x':zoom_x,'y':zoom_y, 'w':zoom_w,'h':zoom_h};
               myStep['mask']={'x':mask_x, 'y':mask_y, 'w':mask_w, 'h':mask_h};
               myStep['mouse'] = {'x':mouse_x,'y':mouse_y};
               mySteps.push(myStep);
           }
           if (s.wait) delay = s.wait;
       }
       maskWindow(fullSequence,0,0,im_w,im_h,1000);
       zoomWindow(fullSequence,0,0,im_w,im_h,1000);
       changeText(fullSequence,{ 'content':'Fin du tutorial !','type':'markdown'});
       
       mySteps[mySteps.length-1]['zoom']={'x':0,'y':0, 'w':im_w,'h':im_h};
       mySteps[mySteps.length-1]['mask']={'x':0, 'y':0, 'w':im_w, 'h':im_h};

   }
   function showImage(image) {
           console.log('showImage '+image);
           $("#im1").attr('src',image);
       }
   function showImageCallback(image) {
            console.log('showImageCallback '+image);
            return function() { showImage(image);};
       }
   function updateCursor(x,y) {
           im_x = x;
           im_y = y;
           viewport_x = (x /im_w) * viewport_w*zoom - viewport_x0;
           viewport_y = (y /im_h) * viewport_h*zoom - viewport_y0;
   }
       
   function updateMask(x,y,w,h) {
       v_x = (x /im_w) * viewport_w*zoom - viewport_x0;
       v_y = (y /im_h) * viewport_h*zoom - viewport_y0;
       v_w = (w / im_w) * viewport_w*zoom;
       v_h = (h / im_h) * viewport_h*zoom;         
    
       lm_w = v_x;
       if (lm_w<0) lm_w=0;
       rm_w = viewport_w-v_x-v_w;
       if (rm_w<0) rm_w=0;
       rm_x = v_x+v_w;
       if (rm_x<0) rm_x=0;
       tm_h = v_y;
       if (tm_h<0) tm_h=0;
       bm_h = viewport_h-v_y-v_h;
       if (bm_h<0) bm_h=0;
       bm_y = v_y+v_h;
       if (bm_y<0) bm_y=0;
   }
   function maskWindow(seq,x,y,w,h,speed,queue) {
           if (speed == undefined) {
            speed=15000;
           }
           if (queue == undefined) {
            queue = true;
           }
           updateMask(x,y,w,h);
           mask_x = x;
           mask_y = y;
           mask_w = w;
           mask_h = h;
           seq.push({ e: $('#leftmask'), p: {width: lm_w}, options: { sequenceQueue: queue, delay:delay, duration: speed,  easing:'easeInSine' } });
           seq.push({ e: $('#rightmask'), p: {width: rm_w,x:rm_x}, options: { delay:delay, duration: speed, sequenceQueue: false, easing:'easeInSine' } });
           seq.push({ e: $('#topmask'), p: {height: tm_h}, options: { delay:delay, duration: speed, sequenceQueue: false, easing:'easeInSine' } });
           seq.push({ e: $('#bottommask'), p: {height: bm_h,y:bm_y}, options: { delay:delay, duration: speed, sequenceQueue: false, easing:'easeInSine' } });

       }
       function updateZoom(_x,_y,_w,_h) {
         x = _x - _w * 0.01;
         y = _y - _h * 0.01;
         w = _w * 1.02;
         h = _h * 1.02;
         
         console.log('x='+x+', y='+y+', w='+w+', h='+h);
         var vx = x / im_w * viewport_w;
         var vy = y / im_h * viewport_h;
         var vw = w / im_w * viewport_w;
         var vh = h / im_h * viewport_h;
         console.log('vx='+vx+', vy='+vy+', vw='+vw+', vh='+vh);

         var zw = viewport_w/vw;
         var zh = viewport_h/vh;
         console.log('zw='+zw,' zh='+zh);
         if (zw>zh) {
            var z = zh;
         } else {
            var z = zw;
         }
         if (z>2) {
            z = 2;
         }
         if (z<1) {
            z = 1;
         }
         
         // Pour centrer la fenetre
         tx0 = viewport_w * (z-1) / 2;
         ty0 = viewport_h * (z-1) / 2;
         cw = (viewport_w - vw * z) /2 - vx*z;
         if (cw>0) cw=0;
         if (cw<-2*tx0) cw = -2*tx0;
         ch = (viewport_h - vh * z) /2 - vy*z;
         if (ch>0) ch=0;
         console.log('cw='+cw+', ch='+ch);
       
         var _tx = tx0 + cw; 

         var _ty = ty0 + ch;
         tx = _tx;
         ty = _ty;
         zoom = z;
         
         viewport_x0 = -cw;
         viewport_y0 = -ch;
       
       }
       function zoomWindow(seq,x,y,w,h,speed,queue) {
         if (speed == undefined) {
            speed=1500;
           }
           if (queue == undefined) {
            queue = true;
           }
         last_tx = tx;
         last_ty = ty;
         last_zoom = zoom;
         updateZoom(x,y,w,h);
         zoom_x = x;
         zoom_y = y;
         zoom_w = w;
         zoom_h = h;
         if ((last_tx != tx) && (last_ty != ty) && ( last_zoom != zoom)) {
             seq.push({ e: $('#im1'), p: {scale:zoom, marginLeft: tx+"px",marginTop:ty+"px"}, options: { delay:delay, duration: speed,  easing:'easeInSine',sequenceQueue:queue } });
             maskWindow(seq,x,y,w,h,speed,false);
             delay = 0;
         }

       }
       function changeImage(seq,image,speed) {
           if (speed == undefined) {
            speed=50;
           }
           console.log('viewport_x='+viewport_x+', viewport_y='+viewport_y);
           seq.push({ e: $('.cursor'), p: {left:(viewport_x)+'px',top:(viewport_y)+'px'}, options: { delay:delay, duration: speed, easing:'easeOutQuart', complete: showImageCallback(image) } });
           delay = 0;
       }
       function showText(s) {
           if (s.type === 'markdown') {
               var content = converter.makeHtml(s.content);
           } else {
               var content = s.content;
           }
           if (s.transition) {
               var transition = s.transition;
           } else {
               var transition = "transition.slideUpBigIn";
           }
           
           $('#info').velocity({ opacity: 0 }, { duration:750, complete: function () {              
               $('#info').html(content);
               if (s.background) $('#info').css('background-color',s.background)
               else $('#info').css('background-color','')
              
            }})
           .velocity(transition); //, { display: null, duration: 1250, stagger: 40  });
       }
       function showTextCallback(s) {
           return function() { showText(s);};
       }
       function changeText(seq,s,speed) {
           if (speed == undefined) {
            speed=50;
           }
           
           seq.push({ e: $('.cursor'), p: {left:(viewport_x)+'px',top:(viewport_y)+'px'}, options: { duration: speed, easing:'easeOutQuart', complete: showTextCallback(s) } });
       }
       function showMessage(seq,s,speed) {
       }          
       
       function moveCursor(seq,nx,ny,speed,complete) {
           if (speed == undefined) {
            speed=1500;
           }
           mouse_x = nx;
           mouse_y = ny;
           if (nx != 0 || ny != 0) {
               console.log('udateCursor '+nx+','+ny);
               updateCursor(nx,ny);
               
               seq.push({ e: $('.cursor'), p: {left:(viewport_x)+'px',top:(viewport_y)+'px'}, options: { delay:delay, duration: speed, easing:'easeOutQuart', complete: complete } });
               seq.push({e: $('.click'), p:{left:(viewport_x-clickcircle/4)+'px',top:(viewport_y-clickcircle/4)+'px',width:(clickcircle/2)+'px',height:(clickcircle/2)+'px'}, options: { delay:delay, duration:0, sequenceQueue: true }});

           }
           delay = 0;
       }
       function startClick(seq,btn,repeat,full,speed) {
           if (speed == undefined) {
            speed=400;
           }
           console.log(repeat);
           if (full == undefined) {
            full=true;
           }
           if (btn == 'Left') {
            var color = 'green';
           } else if (btn == 'Right') {
            var color = 'yellow';
           } else if (btn == 'Middle') {
            var color = 'red';
           }
           console.log(color);
           for (r=0;r<repeat;r++) {
               seq.push({e: $('.click'), p:{ left:(viewport_x-clickcircle/2)+'px',top:(viewport_y-clickcircle/2)+'px',width:(clickcircle)+'px',height:(clickcircle)+'px'}, options: { delay:delay, duration:0, complete: function () { $('.click').css('border-color',color).css('visibility','visible');} }});
               seq.push({ e: $('.click'), p: {left:(viewport_x-clickcircle/4)+'px',top:(viewport_y-clickcircle/4)+'px',width:(clickcircle/2)+'px',height:(clickcircle/2)+'px'}, options: { duration: speed/repeat}});
           }
           if (full) {
               seq.push({ e: $('.click'), p: {left:(viewport_x-2)+'px',top:(viewport_y-2)+'px',width:'4px',height:'4px'}, options: { duration: speed/repeat, complete: function () { $('.click').css('visibility','hidden');}}});
           }
           delay = 0;

       }
       
       function endClick(seq,speed) {
           if (speed == undefined) {
              speed=400;
           }
           seq.push({ e: $('.click'), p: {left:(viewport_x-2)+'px',top:(viewport_y-2)+'px',width:'4px',height:'4px'}, options: { duration: speed, complete: function () { $('.click').css('visibility','hidden');}}});
       }
      function addStepTitle(seq,title,speed) {
       if (speed == undefined) speed = 500;
       seq.push({ e: $('#step'), p: 'transition.slideUpOut', options:{ duration:500, complete: function () {
                   $('#step').html(title); }}});
       seq.push({ e: $('#step'), p: 'transition.slideUpIn',options: { duration: speed }});
   }


$(document).ready(function(){
    
    //$.getJSON( "test.json", function( data ) {
    //    sce = data;
    //});
    $("#im1").attr('src',sce['steps'][0]['image']);
   
    $("#play").click(function(){
        play();
    });   
    $('#start').click(function() {
        jumpStep(0);
    });
    $('#next').click(function() {
        jumpStep(currentStep+1);
    });
    $('#previous').click(function() {
        jumpStep(currentStep-1);
    });
   
   
   $( window ).resize(function() {
       
        location.reload();
    });
   
   function jumpStep(step,force) {
       $('#leftmask').velocity('stop');
       $('#rightmask').velocity('stop');
       $('#topmask').velocity('stop');
       $('#bottommask').velocity('stop');
       $('#im1').velocity('stop');
       $('.cursor').velocity('stop');
       $('#step').velocity('stop');
       $('.click').velocity('stop').css('visibility','hidden');
       $('#info').velocity('stop');
       
       playon = false;
       if (force == undefined) {
           force = false;
       }
       
       if (force || (step<mySteps.length && step>=0 && step != currentStep)) {
               newSequence = [];
               currentStep = step;
               initStep(step);
               $.Velocity.RunSequence(newSequence);
       }
   } 
   function play() {
       if (currentStep >= mySteps.length) {
           return
           //var end = fullSequence.length;
       }

       if (playon == true) {
          jumpStep(currentStep,true);
          return
       }
       playon = true;
       newSequence = [];
       
       start = mySteps[currentStep]['i'];
       //var end = mySteps[currentStep+1]['i'];
       var end = fullSequence.length;

       for (i = start; i<end;i++) {
           newSequence.push(fullSequence[i]);
       }
       $.Velocity.RunSequence(newSequence);
      
   }

       
       
   $(function () {
  $('[data-toggle="popover"]').popover()
  })
});
</script> 
</head>
<body>
<div class="container">
<div class="row">
<div class="col-md-12">

<div class="btn-group" style="display:block;">
<button id="start" type="button" class="btn btn-primary"><i class="fa fa-fast-backward"></i></button>
<button id="previous" type="button" class="btn btn-primary"><i class="fa fa-step-backward"></i></button>
<button id="play" type="button" class="btn btn-primary"><i class="fa fa-play"></i></button>
<button id="next" type="button" class="btn btn-primary"><i class="fa fa-step-forward"></i></button>
</div>
<div style="text-align:center;display:block;"><span id="step" class="anim" style="font-size:150%;"></span></div>
</div>
</div>
<div class="row">
    <div class="col-md-12">
    <div class="panel panel-default">
        <div class="panel-body">
            <div id="viewport">
                <img id="im1" class="image anim" onload="initViewport();"/>
                <svg id="mask" style="left:0;top:0;opacity:0.8; position: absolute;">
                <rect id="leftmask" class="anim" x="1" y="1" width="100" height="100" style="stroke: none; fill: #ffffff;"/>
                <rect id="rightmask" class="anim" x="1" y="1" width="100" height="100" style="stroke: none; fill: #ffffff;"/>
                <rect id="topmask" class="anim" x="1" y="1" width="100" height="100" style="stroke: none; fill: #ffffff;"/>
                <rect id="bottommask" class="anim" x="1" y="1" width="100" height="100" style="stroke: none; fill: #ffffff;"/>
                </svg>
                <div style="left:0; top:0; position: absolute;">
            		<div class="click" class="anim"></div>
            		<img class="cursor"  class="anim" src="cursor.png"/>
                </div>
                <div class="info msgbox" style="opacity:0;"><span style="width:100%;">test</span></div>

            </div>

        </div>
    </div>
    </div>
<div class="col-md-12">
<div class="info" id="info" style="opacity:0;"></div>
 
</div>

</div>
</div>
</body>
</html>

